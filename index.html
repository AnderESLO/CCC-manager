<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor Pool Minimal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #101322;
      --panel: #171b2b;
      --text: #e6edf3;
      --muted: #8a93a8;
      --accent: #2196f3;
      --border: #22273a;
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,sans-serif; }
    header { padding:18px 0 8px 0; border-bottom:1px solid var(--border); }
    .container { max-width:900px; margin:0 auto; padding:0 12px; }
    .brand { font-weight:700; font-size:18px; letter-spacing:.5px; display:flex; align-items:center; gap:10px; }
    .tabs { display:flex; gap:6px; margin:12px 0; }
    .tab-btn { background:var(--panel); color:var(--text); border:none; border-radius:var(--radius); padding:8px 16px; cursor:pointer; font-size:15px; }
    .tab-btn.active { background:var(--accent); color:#fff; }
    main { margin:30px auto; max-width:900px; padding:0 12px; }
    .card { background:var(--panel); border-radius:var(--radius); padding:18px; margin-bottom:18px; border:1px solid var(--border);}
    h2 { font-size:20px; margin-bottom:10px; font-weight:700; }
    h3 { font-size:16px; margin-bottom:6px; font-weight:600; }
    label { font-size:13px; color:var(--muted); margin-bottom:2px; display:block; }
    input, select { width:100%; background:#12152a; border:1px solid var(--border); color:var(--text); border-radius:6px; padding:7px 10px; font-size:15px; margin-bottom:8px; }
    input:focus, select:focus { outline:1px solid var(--accent); }
    button, .btn { background:var(--accent); color:#fff; border:none; border-radius:7px; padding:9px 16px; font-size:15px; cursor:pointer; margin-top:6px; }
    .btn.secondary { background:var(--panel); color:var(--text); border:1px solid var(--border);}
    table { width:100%; border-collapse:collapse; font-size:14px; margin-top:8px;}
    th, td { padding:8px 5px; border-bottom:1px solid var(--border);}
    th { color:var(--muted); font-weight:500; }
    tr:last-child td { border-bottom:none;}
    .num { text-align:right;}
    .pill { font-size:12px; background:#101322; color:var(--accent); border-radius:6px; padding:2px 8px;}
    .mt { margin-top:10px;}
    .flex { display:flex; gap:10px; }
    .mb { margin-bottom:10px;}
    .notice { background:#141728; color:var(--muted); font-size:13px; padding:7px 10px; border-radius:7px;}
    canvas { background:#101322; margin-top:8px; border-radius:7px;}
    .hidden { display:none;}
    .actions { display:flex; gap:6px; }
  </style>
</head>
<body>
  <header>
    <div class="container brand">
      <i class="ti ti-chart-line" style="color:var(--accent);font-size:22px"></i>
      Gestor Pool Minimal
    </div>
    <div class="container tabs">
      <button class="tab-btn active" data-tab="dashboard">Tablero</button>
      <button class="tab-btn" data-tab="ops">Movimientos</button>
      <button class="tab-btn" data-tab="clients">Clientes</button>
      <button class="tab-btn" data-tab="config">Config</button>
    </div>
  </header>
  <main>
    <!-- TABLERO -->
    <section id="dashboard" class="card tabpanel active">
      <h2>Tablero</h2>
      <div class="flex mb">
        <div>
          <div class="pill">Pool actual</div>
          <div id="k_pool" style="font-size:22px;">—</div>
        </div>
        <div>
          <div class="pill">Trades</div>
          <div id="k_trades" style="font-size:22px;">—</div>
        </div>
        <div>
          <div class="pill">Comisiones</div>
          <div id="k_comms" style="font-size:22px;">—</div>
        </div>
      </div>
      <h3>Curva del Pool</h3>
      <canvas id="chartPool" height="120"></canvas>
      <h3 class="mt">Participaciones</h3>
      <table id="tblShares">
        <thead>
          <tr>
            <th>Cliente</th><th class="num">Saldo</th><th class="num">%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- MOVIMIENTOS -->
    <section id="ops" class="card tabpanel hidden">
      <h2>Movimientos</h2>
      <form id="txForm">
        <div class="flex">
          <div style="flex:2">
            <label>Tipo</label>
            <select id="t_type">
              <option value="deposit">Depósito</option>
              <option value="withdrawal">Retiro</option>
              <option value="transfer">Transferencia</option>
              <option value="trade">Trade (pool)</option>
            </select>
          </div>
          <div style="flex:2">
            <label>Fecha/hora</label>
            <input id="t_datetime" type="datetime-local" />
          </div>
        </div>
        <div class="flex">
          <div style="flex:2" id="boxClient">
            <label>Cliente</label>
            <select id="t_client"></select>
          </div>
          <div style="flex:2" id="boxTransfer" class="hidden">
            <label>De</label><select id="trf_from"></select>
            <label>A</label><select id="trf_to"></select>
            <label>Monto</label><input id="trf_amount" type="number" step="0.01" />
          </div>
        </div>
        <div>
          <label>Concepto/Símbolo</label>
          <input id="t_symbol" />
        </div>
        <div id="boxMoney">
          <label>Monto</label>
          <input id="t_amount" type="number" step="0.01" />
          <label>Nota</label>
          <input id="t_note" />
        </div>
        <div id="boxTrade" class="hidden">
          <label>Invertido (pool)</label>
          <input id="tr_invested" type="number" step="0.01" />
          <label>P&L realizado</label>
          <input id="tr_pnl" type="number" step="0.01" />
          <label>Fee broker</label>
          <input id="tr_fees" type="number" step="0.01" value="0" />
        </div>
        <div class="flex mt">
          <button class="btn" type="submit">Guardar</button>
          <button class="btn secondary" type="button" id="btnNewTx">Nuevo</button>
        </div>
      </form>
      <h3 class="mt">Historial</h3>
      <table id="txTable">
        <thead>
          <tr>
            <th>Fecha</th><th>Tipo</th><th>Cliente</th><th>Concepto</th>
            <th class="num">Monto</th><th class="num">P&L</th><th class="num">Fee</th>
            <th class="num">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- CLIENTES -->
    <section id="clients" class="card tabpanel hidden">
      <h2>Clientes</h2>
      <form id="clientForm">
        <div class="flex">
          <div style="flex:2">
            <label>Nombre</label>
            <input id="c_name" />
          </div>
          <div style="flex:1">
            <label>Moneda</label>
            <select id="c_currency"><option>USD</option><option>MXN</option><option>EUR</option></select>
          </div>
          <div style="flex:1">
            <label>Comisión (%)</label>
            <input id="c_commission" type="number" step="0.01" />
          </div>
          <div style="flex:1">
            <label>Comisión activa</label>
            <select id="c_commission_enabled"><option value="true">Sí</option><option value="false">No</option></select>
          </div>
        </div>
        <label>Notas</label>
        <input id="c_notes" />
        <div class="flex mt">
          <button class="btn" type="submit">Guardar</button>
          <button class="btn secondary" type="button" id="btnNewClient">Nuevo</button>
        </div>
      </form>
      <h3 class="mt">Listado</h3>
      <table id="clientsTable">
        <thead>
          <tr>
            <th>Cliente</th><th>Aporte</th><th>Part.</th><th>Comisión</th><th class="num">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- CONFIG -->
    <section id="config" class="card tabpanel hidden">
      <h2>Config</h2>
      <form id="settingsForm">
        <label>Moneda por defecto</label>
        <select id="s_currency"><option>USD</option><option>MXN</option><option>EUR</option></select>
        <label>Formato local</label>
        <select id="s_locale"><option>en-US</option><option>es-MX</option><option>es-ES</option></select>
        <label>Comisión solo sobre P&L positivo</label>
        <select id="s_positive_only"><option value="true">Sí</option><option value="false">No</option></select>
        <button class="btn mt" type="submit">Guardar</button>
      </form>
      <div class="mt notice">
        <b>Respaldo:</b>
        <button class="btn secondary" id="btnExportJSON">Exportar JSON</button>
        <label class="btn secondary" for="fileImport">Importar JSON</label>
        <input id="fileImport" type="file" accept="application/json" style="display:none" />
      </div>
    </section>
  </main>
  <script>
    // --- Estado y utilidades
    const LS_KEY = 'poolMinimalApp';
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const nowLocalISO = ()=>{const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,16)};
    const uid = ()=>Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4);
    const fmt = (n,c='USD',l='en-US')=> new Intl.NumberFormat(l,{style:'currency',currency:c}).format(n||0);
    const round2 = n=>Math.round((n+Number.EPSILON)*100)/100;
    const defaultState={clients:[],txs:[],settings:{currency:'USD',locale:'en-US',positiveOnly:true}};
    let state=load();
    function load(){try{return JSON.parse(localStorage.getItem(LS_KEY))||structuredClone(defaultState)}catch(e){return structuredClone(defaultState)}}
    function save(){localStorage.setItem(LS_KEY,JSON.stringify(state))}

    // --- Tabs
    $$('.tab-btn').forEach(b=>b.addEventListener('click',()=>{ $$('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); $$('.tabpanel').forEach(p=>p.classList.add('hidden')); $('#'+b.dataset.tab).classList.remove('hidden'); if(b.dataset.tab==='dashboard') refreshDashboard(); if(b.dataset.tab==='ops') refreshOpsUI(); if(b.dataset.tab==='clients') renderClients(); }));

    // --- Clientes
    let editingClientId=null;
    function clearClientForm(){editingClientId=null; $('#c_name').value=''; $('#c_currency').value=state.settings.currency; $('#c_commission').value='20'; $('#c_commission_enabled').value='true'; $('#c_notes').value='';}
    $('#btnNewClient').addEventListener('click',clearClientForm);
    $('#clientForm').addEventListener('submit',function(e){
      e.preventDefault();
      const c={id:editingClientId||uid(),name:$('#c_name').value.trim(),currency:$('#c_currency').value,commissionRate:parseFloat($('#c_commission').value||'0')/100,commissionEnabled:$('#c_commission_enabled').value==='true',notes:$('#c_notes').value||''};
      if(!c.name) return alert('Nombre obligatorio');
      const i=state.clients.findIndex(x=>x.id===c.id);
      if(i>=0) state.clients[i]=c; else state.clients.push(c);
      save(); renderClients(); fillClientSelects(); clearClientForm();
    });
    function renderClients(){
      const tbody=$('#clientsTable tbody'); tbody.innerHTML='';
      const shares=balancesAt(new Date().toISOString());
      const total=[...shares.values()].reduce((s,x)=>s+x,0) || 0;
      for(const c of state.clients){
        const bal=round2(shares.get(c.id)||0);
        const pct=total? ((bal/total)*100).toFixed(2)+'%':'—';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><strong>${c.name}</strong></td><td>${fmt(bal,c.currency,state.settings.locale)}</td><td>${pct}</td><td>${c.commissionEnabled? `<span class="pill">${(c.commissionRate*100).toFixed(1)}%</span>`:'<span class="pill">off</span>'}</td>
        <td class="num actions"><button class="btn secondary" data-act="edit" data-id="${c.id}">Editar</button><button class="btn secondary" data-act="del" data-id="${c.id}">Eliminar</button></td>`;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('button').forEach(btn=>{
        const id=btn.dataset.id, act=btn.dataset.act;
        btn.addEventListener('click',()=>{
          if(act==='edit'){
            const c=state.clients.find(x=>x.id===id); if(!c) return;
            editingClientId=c.id; $('#c_name').value=c.name; $('#c_currency').value=c.currency;
            $('#c_commission').value=(c.commissionRate*100).toFixed(2);
            $('#c_commission_enabled').value=String(c.commissionEnabled);
            $('#c_notes').value=c.notes||'';
          } else if(act==='del'){
            if(confirm('¿Eliminar cliente y sus movimientos?')){
              state.clients=state.clients.filter(x=>x.id!==id);
              state.txs=state.txs.filter(x=>x.clientId!==id&&x.fromId!==id&&x.toId!==id);
              save(); renderClients(); refreshOpsUI(); refreshDashboard();
            }
          }
        });
      });
    }
    function fillClientSelects(){
      const opts=state.clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      $('#t_client').innerHTML='<option value="">— Elegir —</option>'+opts;
      $('#trf_from').innerHTML=opts; $('#trf_to').innerHTML=opts;
    }

    // --- Movimientos
    let editingTxId=null;
    function clearTxForm(){
      editingTxId=null;
      $('#t_type').value='deposit'; $('#t_datetime').value=nowLocalISO();
      $('#t_client').value=''; $('#t_symbol').value=''; $('#t_amount').value=''; $('#t_note').value='';
      $('#tr_invested').value=''; $('#tr_pnl').value=''; $('#tr_fees').value='0';
      $('#trf_from').value=''; $('#trf_to').value=''; $('#trf_amount').value='';
      showTxFormBoxes();
    }
    $('#btnNewTx').addEventListener('click',clearTxForm);
    $('#t_type').addEventListener('change',showTxFormBoxes);
    function showTxFormBoxes(){
      const type=$('#t_type').value;
      $('#boxTrade').classList.toggle('hidden',type!=='trade');
      $('#boxMoney').classList.toggle('hidden',!(type==='deposit'||type==='withdrawal'));
      $('#boxClient').classList.toggle('hidden',!(type==='deposit'||type==='withdrawal'));
      $('#boxTransfer').classList.toggle('hidden',type!=='transfer');
    }
    $('#txForm').addEventListener('submit',function(e){
      e.preventDefault();
      const type=$('#t_type').value;
      const datetime=$('#t_datetime').value;
      if(!datetime) return alert('Fecha/hora requerida');
      const iso=new Date(datetime).toISOString();
      let tx={id:editingTxId||uid(),type,datetime:iso,symbol:$('#t_symbol').value||'',note:$('#t_note').value||''};
      if(type==='trade'){
        tx.invested=parseNum($('#tr_invested').value);
        tx.pnl=parseNum($('#tr_pnl').value);
        tx.fees=parseNum($('#tr_fees').value)||0;
        if(isNaN(tx.invested)||isNaN(tx.pnl)) return alert('Datos de trade inválidos');
      } else if(type==='transfer'){
        const fromId=$('#trf_from').value, toId=$('#trf_to').value;
        const amount=parseNum($('#trf_amount').value);
        if(!fromId||!toId) return alert('Selecciona origen y destino');
        if(fromId===toId) return alert('Origen y destino no pueden ser el mismo');
        if(isNaN(amount)||amount<=0) return alert('Monto inválido');
        tx.fromId=fromId; tx.toId=toId; tx.amount=amount;
      } else {
        const clientId=$('#t_client').value;
        if(!clientId) return alert('Selecciona cliente');
        tx.clientId=clientId;
        const amt=parseNum($('#t_amount').value);
        if(isNaN(amt)) return alert('Monto inválido');
        tx.amount=amt;
        if(type==='withdrawal' && amt<0) tx.amount=-amt;
        if(type==='deposit' && amt<0){tx.type='withdrawal'; tx.amount=-amt;}
      }
      const i=state.txs.findIndex(x=>x.id===tx.id);
      if(i>=0) state.txs[i]=tx; else state.txs.push(tx);
      sortTxs(); save(); clearTxForm(); renderTxs(); renderClients(); refreshDashboard();
    });
    function sortTxs(){ state.txs.sort((a,b)=> new Date(a.datetime)-new Date(b.datetime)) }
    function parseNum(v){const n=parseFloat(v); return isNaN(n)? NaN:n}
    function renderTxs(){
      const tbody=$('#txTable tbody'); tbody.innerHTML='';
      for(const tx of state.txs){
        const d=new Date(tx.datetime);
        let who='—',concept='',amt='—',pnl='—',fee='—',typeTxt='';
        if(tx.type==='deposit'||tx.type==='withdrawal'){
          typeTxt=tx.type==='deposit'?'Depósito':'Retiro';
          who = state.clients.find(c=>c.id===tx.clientId)?.name||'—';
          amt=fmt(tx.amount,state.settings.currency,state.settings.locale); concept=tx.symbol||tx.note||'';
        } else if(tx.type==='trade'){
          typeTxt='Trade';
          who='Pool'; concept=tx.symbol||tx.note||'';
          amt=fmt(tx.invested,state.settings.currency,state.settings.locale);
          pnl=fmt(tx.pnl,state.settings.currency,state.settings.locale);
          fee=fmt(tx.fees||0,state.settings.currency,state.settings.locale);
        } else if(tx.type==='transfer'){
          typeTxt='Transferencia';
          const from=state.clients.find(c=>c.id===tx.fromId)?.name||'—';
          const to=state.clients.find(c=>c.id===tx.toId)?.name||'—';
          who = `${from} → ${to}`; concept=tx.symbol||tx.note||'Transferencia';
          amt=fmt(tx.amount,state.settings.currency,state.settings.locale);
        }
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${d.toLocaleString('es-MX').replace('T',' ')}</td><td>${typeTxt}</td><td>${who}</td><td>${concept}</td><td class="num">${amt}</td><td class="num">${pnl}</td><td class="num">${fee}</td>
        <td class="num actions"><button class="btn secondary" data-edit="${tx.id}">Editar</button><button class="btn secondary" data-del="${tx.id}">Eliminar</button></td>`;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{
        const id=b.dataset.del; if(confirm('¿Eliminar movimiento?')){
          state.txs=state.txs.filter(x=>x.id!==id); save(); renderTxs(); refreshDashboard(); renderClients();
        }
      }));
      tbody.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>{
        const id=b.dataset.edit; const tx=state.txs.find(x=>x.id===id); if(!tx) return;
        editingTxId=id; $('#t_type').value=tx.type; $('#t_datetime').value=tx.datetime.slice(0,16);
        $('#t_symbol').value=tx.symbol||''; $('#t_note').value=tx.note||'';
        showTxFormBoxes();
        if(tx.type==='trade'){
          $('#tr_invested').value=tx.invested; $('#tr_pnl').value=tx.pnl; $('#tr_fees').value=tx.fees||0;
        } else if(tx.type==='transfer'){
          $('#trf_from').value=tx.fromId; $('#trf_to').value=tx.toId; $('#trf_amount').value=tx.amount;
        } else { $('#t_client').value=tx.clientId; $('#t_amount').value=tx.amount; }
      });
    }

    // --- Modelo Pool
    function commissionForClient(client, basePnl){ if(!client.commissionEnabled) return 0; if(state.settings.positiveOnly && basePnl<=0) return 0; return round2((client.commissionRate||0) * basePnl); }
    function balancesAt(isoAt){
      const map=new Map(); for(const c of state.clients) map.set(c.id,0);
      const ordered=[...state.txs].sort((a,b)=> new Date(a.datetime)-new Date(b.datetime));
      for(const tx of ordered){
        if(new Date(tx.datetime) > new Date(isoAt)) break;
        if(tx.type==='deposit'){ map.set(tx.clientId, round2((map.get(tx.clientId)||0) + tx.amount)); }
        else if(tx.type==='withdrawal'){ map.set(tx.clientId, round2((map.get(tx.clientId)||0) - tx.amount)); }
        else if(tx.type==='transfer'){ map.set(tx.fromId, round2((map.get(tx.fromId)||0) - tx.amount)); map.set(tx.toId, round2((map.get(tx.toId)||0) + tx.amount)); }
        else if(tx.type==='trade'){ allocateTrade(map, tx); }
      }
      return map;
    }
    function allocateTrade(map, trade){
      const total=[...map.values()].reduce((s,x)=>s+x,0); if(total<=0) return;
      const base=(trade.pnl||0)-(trade.fees||0);
      for(const c of state.clients){
        const bal=map.get(c.id)||0; if(bal<=0) continue;
        const w=bal/total; const pnlShare=round2(base*w);
        const comm=commissionForClient(c, pnlShare);
        map.set(c.id, round2(bal + pnlShare - comm));
      }
    }

    // --- Dashboard
    function refreshDashboard(){
      const nowISO=new Date().toISOString();
      const bal=balancesAt(nowISO);
      const pool=[...bal.values()].reduce((s,x)=>s+x,0);
      $('#k_pool').textContent=fmt(pool,state.settings.currency,state.settings.locale);
      const trades=state.txs.filter(x=>x.type==='trade').length; $('#k_trades').textContent=trades;
      let comms=0;
      const map=new Map(); for(const c of state.clients) map.set(c.id,0);
      const ord=[...state.txs].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
      for(const tx of ord){
        if(tx.type==='deposit'){ map.set(tx.clientId, (map.get(tx.clientId)||0)+tx.amount);}
        else if(tx.type==='withdrawal'){ map.set(tx.clientId, (map.get(tx.clientId)||0)-tx.amount);}
        else if(tx.type==='transfer'){ map.set(tx.fromId, round2((map.get(tx.fromId)||0)-tx.amount)); map.set(tx.toId, round2((map.get(tx.toId)||0)+tx.amount));}
        else {
          const base=(tx.pnl||0)-(tx.fees||0); const pool=[...map.values()].reduce((s,x)=>s+x,0);
          if(pool>0){ for(const c of state.clients){ const bal=map.get(c.id)||0;
            if(bal<=0) continue; const share=base*(bal/pool);
            comms += commissionForClient(c, share); map.set(c.id, round2(bal + share - commissionForClient(c,share)));
          }}
        }
      }
      $('#k_comms').textContent=fmt(comms,state.settings.currency,state.settings.locale);

      // Chart
      const series=poolSeries();
      drawLineChart('chartPool', series.labels, series.values);

      // Participaciones
      const tbody=$('#tblShares tbody'); tbody.innerHTML='';
      const total=pool||1;
      for(const c of state.clients){
        const balc=round2(bal.get(c.id)||0);
        const pct=((balc/total)*100)||0;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${c.name}</td><td class="num">${fmt(balc,c.currency,state.settings.locale)}</td><td class="num">${pct.toFixed(2)}%</td>`;
        tbody.appendChild(tr);
      }
    }
    function poolSeries(){
      const labels=[], values=[];
      const map=new Map(); for(const c of state.clients) map.set(c.id,0);
      const ordered=[...state.txs].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
      for(const tx of ordered){
        if(tx.type==='deposit'){ map.set(tx.clientId, round2((map.get(tx.clientId)||0)+tx.amount);}
        else if(tx.type==='withdrawal'){ map.set(tx.clientId, round2((map.get(tx.clientId)||0)-tx.amount);}
        else if(tx.type==='transfer'){ map.set(tx.fromId, round2((map.get(tx.fromId)||0)-tx.amount)); map.set(tx.toId, round2((map.get(tx.toId)||0)+tx.amount);}
        else { allocateTrade(map, tx);}
        labels.push(tx.datetime.slice(0,16).replace('T',' '));
        values.push(round2([...map.values()].reduce((s,x)=>s+x,0)));
      }
      return {labels, values};
    }
    function drawLineChart(id,labels,data){
      const el=$(id); if(!el) return;
      const ctx=el.getContext('2d');
      if(el._chart) el._chart.destroy();
      el._chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{data,label:'Pool',borderColor:'#2196f3',backgroundColor:'rgba(33,150,243,0.2)',fill:true}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:true}}}});
    }

    // --- Configuración y respaldo
    $('#settingsForm').addEventListener('submit',function(e){
      e.preventDefault();
      state.settings.currency=$('#s_currency').value;
      state.settings.locale=$('#s_locale').value;
      state.settings.positiveOnly=$('#s_positive_only').value==='true';
      save(); renderClients(); refreshDashboard(); alert('Guardado');
    });
    $('#btnExportJSON').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='pool_backup.json';
      a.click();
    });
    $('#fileImport').addEventListener('change',e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ try{
        const data=JSON.parse(r.result);
        if(!data.clients||!data.txs) throw new Error('Archivo inválido');
        state=data; save(); location.reload();
      }catch(err){ alert('Error: '+err.message) } };
      r.readAsText(f);
    });

    // --- Inicialización
    function init(){
      renderClients(); fillClientSelects(); refreshOpsUI(); refreshDashboard();
    }
    function refreshOpsUI(){ fillClientSelects(); renderTxs(); }
    document.addEventListener('DOMContentLoaded',()=>{
      if(!state.clients.length && !state.txs.length){
        // Datos demo
        const cB={id:uid(),name:'Brandon',currency:'USD',commissionRate:.2,commissionEnabled:true,notes:''};
        const cV={id:uid(),name:'Victor', currency:'USD',commissionRate:.2,commissionEnabled:true,notes:''};
        const cA={id:uid(),name:'Ander',  currency:'USD',commissionRate:.2,commissionEnabled:true,notes:''};
        state.clients.push(cB,cV,cA);
        const daysAgo=d=>{const x=new Date(); x.setDate(x.getDate()-d); return x.toISOString()};
        state.txs.push(
          {id:uid(),type:'deposit',clientId:cB.id,datetime:daysAgo(2),amount:4004.11,note:'Saldo inicial Brandon'},
          {id:uid(),type:'deposit',clientId:cV.id,datetime:daysAgo(2),amount:3387.64,note:'Saldo inicial Victor'},
          {id:uid(),type:'deposit',clientId:cA.id,datetime:daysAgo(2),amount:209.44,note:'Saldo inicial Ander'}
        );
        sortTxs(); save();
      }
      init();
    });
  </script>
</body>
</html>
