<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Gestor de Pool</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tabler Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#0b1220;--panel:#111a2b;--text:#e6edf3;--muted:#9fb3c8;--border:rgba(255,255,255,.08);--radius:12px;--blue:#2196f3}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,sans-serif}
    .container{max-width:940px;margin:0 auto;padding:1rem}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:1rem}
    .tabs{display:flex;gap:.5rem;overflow-x:auto}
    .tab-btn{white-space:nowrap;border:1px solid var(--border);border-radius:999px;padding:.5rem .9rem;background:#162036}
    .tab-btn.active{background:#20324e}
    .tabpanel{display:none}
    .tabpanel.active{display:block}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:.6rem}
    th{text-align:left;color:var(--muted);font-weight:600}
    .num{text-align:right}
    .chart-wrap{position:relative;width:100%;height:300px}
    @media(min-width:768px){.chart-wrap{height:360px}}
    canvas{display:block;max-width:100%;max-height:100%}
    .btn{background:#1b2b49;color:#fff;border-radius:10px;padding:.55rem 1rem}
    .btn.primary{background:var(--blue)}
    .muted{color:var(--muted)}
    .pill{background:#10243e;color:#b9ddff;border:1px solid #1c3b61;border-radius:9999px;padding:.15rem .6rem;font-size:.75rem}
  </style>
</head>
<body>
  <header class="border-b border-[rgba(255,255,255,.08)]">
    <div class="container py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2"><i class="ti ti-chart-line text-blue-400 text-xl"></i><span class="font-bold text-lg">Gestor de Pool</span></div>
        <span id="liveClock" class="pill">—</span>
      </div>
      <div class="tabs mt-2">
        <button class="tab-btn active" data-tab="tablero">Tablero</button>
        <button class="tab-btn" data-tab="operaciones">Movimientos</button>
        <button class="tab-btn" data-tab="clientes">Clientes</button>
        <button class="tab-btn" data-tab="config">Config</button>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <!-- TABLERO -->
    <section id="tablero" class="tabpanel active">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card"><div class="muted text-sm">Pool actual</div><div class="text-3xl font-bold" id="k_pool">—</div></div>
        <div class="card"><div class="muted text-sm">Total Trades</div><div class="text-3xl font-bold" id="k_trades">—</div></div>
        <div class="card"><div class="muted text-sm">Comisiones totales</div><div class="text-3xl font-bold" id="k_comms">—</div></div>
      </div>
      <div class="card">
        <h3 class="font-bold mb-2">Evolución del Pool</h3>
        <div class="chart-wrap"><canvas id="poolChart"></canvas></div>
      </div>
      <div class="card">
        <div class="flex items-center justify-between"><h3 class="font-bold">Proyecciones</h3>
          <select id="projectionPeriod" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-2 py-1">
            <option value="30">1 Mes</option>
            <option value="90">3 Meses</option>
            <option value="180">6 Meses</option>
            <option value="365">1 Año</option>
          </select>
        </div>
        <div class="chart-wrap"><canvas id="projectionsChart"></canvas></div>
        <div class="overflow-x-auto mt-3">
          <table id="projectionsTable"><thead><tr><th>Día</th><th class="num">Valor Proyectado</th><th class="num">Rend. Acum.</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="card">
        <h3 class="font-bold mb-2">Participaciones actuales</h3>
        <div class="overflow-x-auto">
          <table id="tblShares"><thead><tr><th>Cliente</th><th class="num">Saldo</th><th class="num">%</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- MOVIMIENTOS -->
    <section id="operaciones" class="tabpanel">
      <div class="card">
        <h3 class="font-bold mb-3">Registrar movimiento</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="block muted text-sm mb-1">Tipo</label>
            <select id="t_type" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full">
              <option value="deposit">Depósito</option>
              <option value="withdrawal">Retiro</option>
              <option value="transfer">Transferencia</option>
              <option value="trade">Trade (pool)</option>
            </select>
          </div>
          <div><label class="block muted text-sm mb-1">Fecha y hora</label>
            <input id="t_datetime" type="datetime-local" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" />
            <div class="text-xs muted mt-1">Se sincroniza automáticamente mientras capturas.</div>
          </div>
          <div id="boxClient"><label class="block muted text-sm mb-1">Cliente</label>
            <select id="t_client" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"></select>
          </div>
          <div class="md:col-span-2" id="boxTransfer" style="display:none">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div><label class="block muted text-sm mb-1">De</label><select id="trf_from" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"></select></div>
              <div><label class="block muted text-sm mb-1">A</label><select id="trf_to" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"></select></div>
              <div><label class="block muted text-sm mb-1">Monto</label><input id="trf_amount" type="number" step="0.01" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" /></div>
            </div>
          </div>
          <div class="md:col-span-2"><label class="block muted text-sm mb-1">Concepto / Símbolo</label>
            <input id="t_symbol" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" placeholder="BTCUSDT / Motivo" />
          </div>
        </div>
        <div id="boxMoney" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
          <div><label class="block muted text-sm mb-1">Monto</label><input id="t_amount" type="number" step="0.01" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" /></div>
          <div class="md:col-span-2"><label class="block muted text-sm mb-1">Nota</label><input id="t_note" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" /></div>
        </div>
        <div id="boxTrade" class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4" style="display:none">
          <div><label class="block muted text-sm mb-1">Invertido</label><input id="tr_invested" type="number" step="0.01" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" /></div>
          <div><label class="block muted text-sm mb-1">P&L realizado</label><input id="tr_pnl" type="number" step="0.01" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" /></div>
          <div><label class="block muted text-sm mb-1">Fees broker</label><input id="tr_fees" type="number" step="0.01" value="0" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" /></div>
        </div>
        <div class="mt-4 flex gap-2">
          <button class="btn primary flex-1" id="btnSaveTx">Guardar movimiento</button>
          <button class="btn flex-1" id="btnNewTx">Nueva captura</button>
        </div>
      </div>

      <div class="card">
        <h3 class="font-bold mb-2">Corte de Periodo</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
          <div><label class="block muted text-sm mb-1">Cliente a comisionar (paga)</label>
            <select id="cutOffClientSelect" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"><option value="">-- Seleccionar --</option></select></div>
          <div><label class="block muted text-sm mb-1">Beneficiario (recibe)</label>
            <select id="commissionBeneficiary" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"><option value="">-- Seleccionar --</option></select>
            <p class="text-xs muted mt-1">Elige quién cobra (p.ej. Brandon o tú).</p>
          </div>
          <div class="flex gap-2"><button class="btn primary w-full" id="btnPreviewCommission">Previsualizar</button></div>
        </div>
        <div id="commissionPreview" class="mt-3 text-sm"></div>
        <div class="mt-3"><button class="btn primary" id="btnCutOffPeriod">Cobrar Comisión</button></div>
        <h4 class="font-bold text-md mt-4 mb-2">Historial de Cierres</h4>
        <div id="periodClosesHistory"></div>
      </div>

      <div class="card">
        <h3 class="font-bold mb-2">Historial</h3>
        <div class="overflow-x-auto">
          <table id="txTable"><thead><tr><th>Fecha</th><th>Tipo</th><th>Cliente</th><th>Concepto</th><th class="num">Monto</th><th class="num">P&L</th><th class="num">Fee</th><th class="num">Acciones</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clientes" class="tabpanel">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-bold mb-3">Crear / Editar cliente</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div><label class="block muted text-sm mb-1">Nombre</label><input id="c_name" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" placeholder="Ej. Ander" /></div>
            <div><label class="block muted text-sm mb-1">Moneda</label><select id="c_currency" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"><option>USD</option><option>MXN</option><option>EUR</option></select></div>
            <div><label class="block muted text-sm mb-1">Comisión (%)</label><input id="c_commission" type="number" min="0" step="0.01" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" placeholder="20" /></div>
            <div><label class="block muted text-sm mb-1">Comisión activa</label><select id="c_commission_enabled" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"><option value="true">Sí</option><option value="false">No</option></select></div>
            <div class="md:col-span-2"><label class="block muted text-sm mb-1">Desde (fecha/hora)</label><input id="c_commission_start" type="datetime-local" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" /></div>
            <div class="md:col-span-2"><label class="block muted text-sm mb-1">Notas</label><input id="c_notes" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full" /></div>
          </div>
          <div class="mt-4 flex gap-2"><button class="btn primary flex-1" id="btnSaveClient">Guardar</button><button class="btn flex-1" id="btnNewClient">Nuevo</button></div>
        </div>
        <div class="card">
          <div class="flex items-center justify-between mb-3"><h3 class="font-bold">Clientes</h3><input id="searchClient" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full max-w-[200px]" placeholder="Buscar…" /></div>
          <div class="overflow-x-auto"><table id="clientsTable"><thead><tr><th>Cliente</th><th class="num">Aporte</th><th class="num">Part.</th><th>Comisión</th><th class="num">Acciones</th></tr></thead><tbody></tbody></table></div>
        </div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="config" class="tabpanel">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-bold mb-3">Respaldo</h3>
          <div class="flex flex-wrap gap-2"><button class="btn" id="btnExportJSON">Exportar</button><label class="btn cursor-pointer" for="fileImport">Importar</label><input id="fileImport" type="file" accept="application/json" class="hidden" /></div>
        </div>
        <div class="card">
          <h3 class="font-bold mb-3">Preferencias</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div><label class="block muted text-sm mb-1">Moneda por defecto</label><select id="s_currency" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"><option>USD</option><option>MXN</option><option>EUR</option></select></div>
            <div><label class="block muted text-sm mb-1">Formato local</label><select id="s_locale" class="bg-[#0f1a2d] border border-[rgba(255,255,255,.08)] rounded px-3 py-2 w-full"><option>es-MX</option><option>en-US</option><option>es-ES</option></select></div>
          </div>
          <button class="btn primary mt-3" id="btnSaveSettings">Guardar</button>
        </div>
      </div>
    </section>
  </main>

  <script>
  'use strict';
  // ===== Estado =====
  const state = { clients: [], txs: [], periodCloses: [], settings: { locale: 'es-MX', currency: 'USD' } };
  let poolChartInstance=null, projChartInstance=null, editingClientId=null; let clockTimer=null, datetimeSyncTimer=null, userEditedDatetime=false;

  // ===== Utils =====
  const uid = () => 'id-' + Math.random().toString(36).slice(2,9); // <- HOTFIX: antes faltaba y rompía todo
  const qs = (s)=>document.querySelector(s); const qsa = (s)=>Array.from(document.querySelectorAll(s));
  const fmtDate = (s,l)=>{if(!s) return ''; const d=new Date(s); return d.toLocaleDateString(l,{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})};
  const fmtMoney = (a,c)=> new Intl.NumberFormat(state.settings.locale||'es-MX',{style:'currency',currency:c||'USD',maximumFractionDigits:2}).format(a||0);
  const nowLocalValue = ()=>{const d=new Date(); d.setSeconds(0,0); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}` };
  const safeChartColor = ()=> getComputedStyle(document.documentElement).getPropertyValue('--blue')||'#2196f3';

  function saveState(){localStorage.setItem('poolState',JSON.stringify(state))}
  function loadState(){try{const st=JSON.parse(localStorage.getItem('poolState')); if(st){ if(st.clients){st.clients=st.clients.map(c=>({...c,commissionRate:parseFloat(c.commissionRate)||0}))} state.clients=st.clients||[]; state.txs=(st.txs||[]).map(t=>({...t,commissionedBy:t.commissionedBy||{}})); state.periodCloses=st.periodCloses||[]; state.settings=st.settings||state.settings; }}catch(e){console.error('loadState',e)}}

  // ===== Cálculos =====
  function clientParticipationAt(clientId,timestamp){const cut=(tx)=> new Date(tx.datetime)<=new Date(timestamp); const base=state.txs.filter(tx=>cut(tx)&&(tx.type==='deposit'||tx.type==='withdrawal')); let client=base.filter(tx=>tx.clientId===clientId).reduce((s,tx)=>s+(tx.type==='deposit'?tx.amount:-tx.amount),0); let total=base.reduce((s,tx)=>s+(tx.type==='deposit'?tx.amount:-tx.amount),0); const trfs=state.txs.filter(tx=>tx.type==='transfer'&&cut(tx)); client+=trfs.filter(t=>t.toId===clientId).reduce((s,t)=>s+t.amount,0); client-=trfs.filter(t=>t.fromId===clientId).reduce((s,t)=>s+t.amount,0); return total>0?client/total:0 }
  function clientBalance(clientId){let bal=0; state.txs.filter(tx=>tx.clientId===clientId).forEach(tx=>{if(tx.type==='deposit') bal+=tx.amount; else if(tx.type==='withdrawal') bal-=tx.amount; else if(tx.type==='commission') bal-=tx.amount}); state.txs.filter(tx=>tx.type==='transfer'&&tx.fromId===clientId).forEach(tx=>bal-=tx.amount); state.txs.filter(tx=>tx.type==='transfer'&&tx.toId===clientId).forEach(tx=>bal+=tx.amount); state.txs.filter(tx=>tx.type==='trade').forEach(tr=>{const p=clientParticipationAt(clientId,tr.datetime); bal+=(tr.pnl-tr.fees)*p}); return bal }
  function totalPool(){let t=0; state.txs.forEach(tx=>{if(tx.type==='deposit') t+=tx.amount; else if(tx.type==='withdrawal') t-=tx.amount; else if(tx.type==='trade') t+=(tx.pnl-tx.fees); else if(tx.type==='commission') t-=tx.amount}); return t }
  function poolHistory(){const sorted=[...state.txs].filter(x=>x.datetime).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)); const valid=new Set(['deposit','withdrawal','trade','commission']); const out=[]; let v=0,last=null; sorted.forEach(tx=>{ if(!valid.has(tx.type)) return; const day=new Date(tx.datetime).toDateString(); if(last && day!==new Date(last).toDateString()) out.push({date:last,value:v}); last=tx.datetime; if(tx.type==='deposit') v+=tx.amount; else if(tx.type==='withdrawal') v-=tx.amount; else if(tx.type==='trade') v+=(tx.pnl-tx.fees); else if(tx.type==='commission') v-=tx.amount; }); if(last) out.push({date:last,value:v}); return out }
  function projections(days){const hist=poolHistory(); if(hist.length<2) return {rows:[],series:[]}; const last=hist[hist.length-1].value; const rlogs=[]; for(let i=1;i<hist.length;i++){const a=hist[i-1].value,b=hist[i].value; if(a>0&&b>0) rlogs.push(Math.log(b/a))} const mu=rlogs.length? rlogs.reduce((s,x)=>s+x,0)/rlogs.length:0; const rows=[],series=[]; let v=last; const step=Math.max(1,Math.ceil(days/20)); for(let d=1; d<=days; d++){ v=v*Math.exp(mu); if(d%step===0||d===days){ rows.push({day:d,value:v,ret:(v/last-1)}); series.push({x:d,y:v}) } } return {rows,series} }
  function commissionPreviewFor(clientId){ if(!clientId) return {total:0,details:[]}; const trades=state.txs.filter(tx=>tx.type==='trade'&&(tx.pnl-tx.fees)>0); const client=state.clients.find(c=>c.id===clientId); if(!client||!client.commissionEnabled) return {total:0,details:[]}; let total=0; const details=[]; trades.forEach(tr=>{const already=tr.commissionedBy&&tr.commissionedBy[clientId]; if(already) return; const part=clientParticipationAt(clientId,tr.datetime); const share=(tr.pnl-tr.fees)*part; const fee=share*client.commissionRate; if(fee>0){ total+=fee; details.push({tradeId:tr.id,note:tr.note||tr.symbol,commission:fee,clientShare:share,date:tr.datetime}) } }); return {total,details}; }

  // ===== Render =====
  function renderClients(){const tb=qs('#clientsTable tbody'); if(!tb) return; tb.innerHTML=''; if(!state.clients.length){tb.innerHTML='<tr><td colspan="5" class="text-center text-blue-300">No hay clientes</td></tr>'; return} const pool=totalPool(); state.clients.forEach(c=>{const bal=clientBalance(c.id); const part=pool>0?(bal/pool*100):0; const comm=c.commissionEnabled?`${(c.commissionRate*100).toFixed(2)}%`:'No'; const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.name}</td><td class="num">${fmtMoney(bal,'USD')}</td><td class="num">${part.toFixed(2)}%</td><td>${comm}</td><td class="num"><button class="text-blue-400 text-sm" data-edit="${c.id}">Editar</button> <button class="text-red-400 text-sm" data-del="${c.id}">Eliminar</button></td>`; tb.appendChild(tr)}); tb.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>editClient(b.dataset.edit))); tb.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>deleteClient(b.dataset.del))); }
  function renderTxs(){const tb=qs('#txTable tbody'); if(!tb) return; tb.innerHTML=''; if(!state.txs.length){tb.innerHTML='<tr><td colspan="8" class="text-center text-blue-300">No hay movimientos</td></tr>'; return} [...state.txs].sort((a,b)=>new Date(b.datetime)-new Date(a.datetime)).forEach(tx=>{const tr=document.createElement('tr'); let who=''; if(tx.type==='trade'){who='Pool'} else if(tx.type==='commission'){who=state.clients.find(c=>c.id===tx.clientId)?.name} else if(tx.type==='transfer'){const f=state.clients.find(c=>c.id===tx.fromId)?.name||'N/A'; const t=state.clients.find(c=>c.id===tx.toId)?.name||'N/A'; who=`${f} → ${t}`} else if(tx.clientId){who=state.clients.find(c=>c.id===tx.clientId)?.name||'N/A'} tr.innerHTML=`<td>${fmtDate(tx.datetime,state.settings.locale)}</td><td>${tx.type}</td><td>${who}</td><td>${tx.symbol||tx.note||'—'}</td><td class="num">${tx.amount?fmtMoney(tx.amount,'USD'):'—'}</td><td class="num">${tx.pnl?fmtMoney(tx.pnl,'USD'):'—'}</td><td class="num">${tx.fees?fmtMoney(tx.fees,'USD'):'—'}</td><td class="num"><button class="text-red-400 text-sm" data-del-tx="${tx.id}">Eliminar</button></td>`; tb.appendChild(tr)}); tb.querySelectorAll('[data-del-tx]').forEach(b=>b.addEventListener('click',()=>deleteTx(b.dataset.delTx))); }
  function renderDashboard(){ if(qs('#k_pool')) qs('#k_pool').textContent=fmtMoney(totalPool(),'USD'); if(qs('#k_trades')) qs('#k_trades').textContent=state.txs.filter(t=>t.type==='trade').length; if(qs('#k_comms')) qs('#k_comms').textContent=fmtMoney(state.txs.filter(t=>t.type==='commission').reduce((s,t)=>s+t.amount,0),'USD'); const body=qs('#tblShares tbody'); if(body){ body.innerHTML=''; const pool=totalPool(); state.clients.forEach(c=>{const bal=clientBalance(c.id); const part=pool>0?(bal/pool*100):0; const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.name}</td><td class="num">${fmtMoney(bal,'USD')}</td><td class="num">${part.toFixed(2)}%</td>`; body.appendChild(tr)}) } renderPoolChart(); renderProjections(); }
  function renderPoolChart(){const hist=poolHistory(); const labels=hist.map(h=> new Date(h.date).toLocaleDateString(state.settings.locale)); const values=hist.map(h=> h.value); const el=qs('#poolChart'); if(!el||!window.Chart) return; if(poolChartInstance) poolChartInstance.destroy(); poolChartInstance=new Chart(el.getContext('2d'),{type:'line',data:{labels,datasets:[{label:'Valor del Pool',data:values,borderColor:safeChartColor(),backgroundColor:'rgba(33,150,243,.18)',fill:true,tension:.25,pointRadius:3,pointHoverRadius:4}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{labels:{color:'#e0e0e0'}},tooltip:{callbacks:{label:(ctx)=> `${ctx.dataset.label}: ${fmtMoney(ctx.parsed.y,'USD')}`}}},scales:{x:{grid:{color:'rgba(255,255,255,.08)'},ticks:{color:'#e0e0e0'}},y:{grid:{color:'rgba(255,255,255,.08)'},ticks:{color:'#e0e0e0'}}}}) }
  function renderProjections(){const el=qs('#projectionsChart'); if(!el||!window.Chart) return; const days=parseInt(qs('#projectionPeriod').value||'30'); const {rows}=projections(days); const tb=qs('#projectionsTable tbody'); if(tb){ tb.innerHTML=''; if(!rows.length){tb.innerHTML='<tr><td colspan="3" class="text-center text-blue-300">No hay suficientes datos</td></tr>'} else {rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>Día ${r.day}</td><td class="num">${fmtMoney(r.value,'USD')}</td><td class="num">${(r.ret*100).toFixed(2)}%</td>`; tb.appendChild(tr)}) } } const hist=poolHistory(); const baseVals=hist.map(h=>h.value); const baseLabels=hist.map((_,i)=> i); const futVals=rows.length? [baseVals[baseVals.length-1], ...rows.map(r=>r.value)] : []; const futLabels=rows.length? [baseLabels.length-1, ...rows.map(r=> baseLabels.length-1 + r.day)] : []; if(projChartInstance) projChartInstance.destroy(); projChartInstance=new Chart(el.getContext('2d'),{type:'line',data:{labels:[...baseLabels,...futLabels],datasets:[{label:'Histórico',data:baseVals,borderColor:safeChartColor(),backgroundColor:'rgba(33,150,243,.15)',fill:true,tension:.25,pointRadius:3},{label:'Proyección',data:[...Array(baseVals.length-1).fill(null), ...futVals],borderColor:'#64b5f6',borderDash:[6,6],tension:.25,pointRadius:3}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{labels:{color:'#e0e0e0'}}},scales:{x:{display:false},y:{ticks:{color:'#e0e0e0'},grid:{color:'rgba(255,255,255,.08)'}}}}) }
  function renderPeriodCloses(){const c=qs('#periodClosesHistory'); if(!c) return; c.innerHTML=''; if(!state.periodCloses.length){c.innerHTML='<p class="text-sm muted">No hay cierres registrados.</p>'; return} [...state.periodCloses].sort((a,b)=>new Date(b.datetime)-new Date(a.datetime)).forEach(cl=>{const cli=state.clients.find(x=>x.id===cl.clientId); const bene=state.clients.find(x=>x.id===cl.beneficiaryId); const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div class="flex justify-between"><b>${cl.periodId}</b><span class="muted text-sm">${fmtDate(cl.datetime,state.settings.locale)}</span></div><div class="text-sm">Comisionado a: <b>${cli?.name||'N/A'}</b> → Beneficiario: <b>${bene?.name||'N/A'}</b></div><div class="text-sm">Comisión total: <b>${fmtMoney(cl.totalCommission,'USD')}</b></div><div class="mt-2 text-sm"><span class="muted">Detalle:</span><ul class="list-disc ml-5">${(cl.details||[]).map(d=>`<li><span class='text-blue-300'>${d.note||'Trade'}</span> • ${fmtDate(d.date,state.settings.locale)} • ${fmtMoney(d.commission,'USD')}</li>`).join('')}</ul></div>`; c.appendChild(div) }) }

  // ===== Acciones =====
  function editClient(id){const c=state.clients.find(x=>x.id===id); if(!c) return; editingClientId=id; qs('#c_name').value=c.name; qs('#c_currency').value=c.currency; qs('#c_commission').value=c.commissionRate*100; qs('#c_commission_enabled').value=c.commissionEnabled.toString(); qs('#c_commission_start').value=c.commissionStart||''; qs('#c_notes').value=c.notes||''; qs('#btnSaveClient').textContent='Guardar Cambios'}
  function deleteClient(id){ if(!confirm('¿Eliminar cliente y sus movimientos?')) return; state.clients=state.clients.filter(c=>c.id!==id); state.txs=state.txs.filter(t=>t.clientId!==id&&t.fromId!==id&&t.toId!==id); saveState(); refreshAll(); }
  function deleteTx(id){ if(!confirm('¿Eliminar movimiento?')) return; state.txs=state.txs.filter(t=>t.id!==id); saveState(); refreshAll(); }
  function fillClientSelects(){['t_client','trf_from','trf_to','cutOffClientSelect','commissionBeneficiary'].forEach(id=>{const s=qs('#'+id); if(!s) return; s.innerHTML='<option value="">-- Seleccionar --</option>'; state.clients.forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; s.appendChild(o)}) }) }
  function doPreview(){const clientId=qs('#cutOffClientSelect').value; const prev=commissionPreviewFor(clientId); const el=qs('#commissionPreview'); if(!clientId){el.innerHTML='<span class="muted">Selecciona el cliente a comisionar.</span>'; return} if(prev.details.length===0){el.innerHTML='<span class="muted">No hay trades positivos sin comisionar desde el último cierre (o inicio).</span>'; return} el.innerHTML=`<div class='p-3 rounded-md border border-blue-600/30 bg-[#0b1b29]'><p><b>Comisión acumulada:</b> ${fmtMoney(prev.total,'USD')}</p><ul class='list-disc ml-5 mt-2'>${prev.details.map(d=>`<li>${fmtDate(d.date,state.settings.locale)} · <span class='text-blue-300'>${d.note||'Trade'}</span> · ${fmtMoney(d.commission,'USD')}</li>`).join('')}</ul></div>` }
  function cutOff(){const clientId=qs('#cutOffClientSelect').value; const beneId=qs('#commissionBeneficiary').value; if(!clientId||!beneId) return alert('Selecciona cliente a comisionar y beneficiario'); const client=state.clients.find(c=>c.id===clientId); if(!client||!client.commissionEnabled) return alert('El cliente no tiene comisión habilitada'); const prev=commissionPreviewFor(clientId); if(prev.total<=0) return alert('No hay comisión pendiente'); if(!confirm(`¿Cobrar ${(client.commissionRate*100).toFixed(2)}% a ${client.name} y pagar a ${state.clients.find(c=>c.id===beneId)?.name}?`)) return; const now=new Date().toISOString(); prev.details.forEach(d=>{const tr=state.txs.find(t=>t.id===d.tradeId); tr.commissionedBy=tr.commissionedBy||{}; tr.commissionedBy[clientId]=true}); state.txs.push({id:uid(),type:'commission',clientId,beneficiaryId:beneId,datetime:now,amount:prev.total,note:`Comisión de periodo (${(client.commissionRate*100).toFixed(2)}%)`}); state.periodCloses.push({id:uid(),periodId:`Cierre de Periodo ${state.periodCloses.length+1}`,datetime:now,clientId,beneficiaryId:beneId,totalCommission:prev.total,details:prev.details}); saveState(); refreshAll(); alert('Corte realizado'); }
  function refreshAll(){renderClients(); renderTxs(); renderDashboard(); fillClientSelects(); renderPeriodCloses(); }

  // ===== Reloj y autofecha =====
  function startClock(){const el=qs('#liveClock'); if(clockTimer) clearInterval(clockTimer); const tick=()=>{el.textContent=new Date().toLocaleString(state.settings.locale||'es-MX')}; tick(); clockTimer=setInterval(tick,1000)}
  function startDatetimeSync(){const input=qs('#t_datetime'); if(!input) return; if(datetimeSyncTimer) clearInterval(datetimeSyncTimer); const sync=()=>{if(!userEditedDatetime){input.value=nowLocalValue()}}; sync(); datetimeSyncTimer=setInterval(sync,15000); input.addEventListener('input',()=>{userEditedDatetime=true}); window.addEventListener('focus',()=>{userEditedDatetime=false; sync()})}

  // ===== Bootstrap seguro =====
  document.addEventListener('DOMContentLoaded',()=>{
    try{
      loadState();
      // Demo si no hay datos
      if(state.clients.length===0 && state.txs.length===0){
        state.clients.push({id:uid(),name:'Brandon',currency:'USD',commissionRate:0.2,commissionEnabled:true},{id:uid(),name:'Victor',currency:'USD',commissionRate:0.2,commissionEnabled:true},{id:uid(),name:'Ander',currency:'USD',commissionRate:0.2,commissionEnabled:true});
        const daysAgo=d=>{const x=new Date(); x.setDate(x.getDate()-d); return x.toISOString()};
        state.txs.push({id:uid(),type:'deposit',clientId:state.clients[0].id,datetime:daysAgo(30),amount:4004.11,note:'Saldo inicial Brandon'},{id:uid(),type:'deposit',clientId:state.clients[1].id,datetime:daysAgo(30),amount:3000,note:'Saldo inicial Victor'},{id:uid(),type:'deposit',clientId:state.clients[2].id,datetime:daysAgo(30),amount:200,note:'Saldo inicial Ander'},{id:uid(),type:'trade',datetime:daysAgo(20),invested:7204.11,pnl:250.7,fees:5.5,note:'Trade 1',commissionedBy:{}},{id:uid(),type:'trade',datetime:daysAgo(10),invested:7450.31,pnl:50.1,fees:1.2,note:'Trade 2',commissionedBy:{}},{id:uid(),type:'withdrawal',clientId:state.clients[1].id,datetime:daysAgo(5),amount:500,note:'Retiro parcial'});
        saveState();
      }

      // Tabs
      qsa('.tab-btn').forEach(btn=>btn.addEventListener('click',e=>{qsa('.tab-btn').forEach(b=>b.classList.remove('active')); qsa('.tabpanel').forEach(p=>p.classList.remove('active')); e.currentTarget.classList.add('active'); const id=e.currentTarget.dataset.tab; qs('#'+id).classList.add('active'); if(id==='tablero') renderDashboard()}));

      // Primera carga
      refreshAll();
      startClock();
      startDatetimeSync();

      // Guardar cliente
      qs('#btnSaveClient')?.addEventListener('click',()=>{const name=qs('#c_name').value.trim(); if(!name) return; const obj={name,currency:qs('#c_currency').value,commissionRate:parseFloat(qs('#c_commission').value)/100||0,commissionEnabled:qs('#c_commission_enabled').value==='true',notes:qs('#c_notes').value,commissionStart:qs('#c_commission_start').value}; if(editingClientId){const i=state.clients.findIndex(c=>c.id===editingClientId); if(i>-1) state.clients[i]={...state.clients[i],...obj}; editingClientId=null; qs('#btnSaveClient').textContent='Guardar'} else {obj.id=uid(); state.clients.push(obj)} saveState(); refreshAll(); qs('#btnNewClient').click()});
      qs('#btnNewClient')?.addEventListener('click',()=>{editingClientId=null; ['#c_name','#c_commission','#c_notes','#c_commission_start'].forEach(s=>qs(s).value=''); qs('#btnSaveClient').textContent='Guardar'});

      // Guardar movimiento
      qs('#btnSaveTx')?.addEventListener('click',()=>{const type=qs('#t_type').value; let datetime=qs('#t_datetime').value; if(!datetime) datetime=nowLocalValue(); const symbol=qs('#t_symbol').value; const note=qs('#t_note').value; let tx={id:uid(),type,datetime,symbol,note}; if(type==='deposit'||type==='withdrawal'){tx.clientId=qs('#t_client').value; tx.amount=parseFloat(qs('#t_amount').value)||0} else if(type==='transfer'){tx.fromId=qs('#trf_from').value; tx.toId=qs('#trf_to').value; tx.amount=parseFloat(qs('#trf_amount').value)||0} else if(type==='trade'){tx.invested=parseFloat(qs('#tr_invested').value)||0; tx.pnl=parseFloat(qs('#tr_pnl').value)||0; tx.fees=parseFloat(qs('#tr_fees').value)||0; tx.commissionedBy={}} state.txs.push(tx); saveState(); refreshAll()});

      // Toggle cajas según tipo
      qs('#t_type')?.addEventListener('change',e=>{const t=e.target.value; qs('#boxClient').style.display=(t==='deposit'||t==='withdrawal')?'block':'none'; qs('#boxTransfer').style.display=(t==='transfer')?'block':'none'; qs('#boxMoney').style.display=(t==='deposit'||t==='withdrawal'||t==='commission')?'grid':'none'; qs('#boxTrade').style.display=(t==='trade')?'grid':'none'}); qs('#t_type')?.dispatchEvent(new Event('change'));

      // Proyecciones y cierres
      qs('#projectionPeriod')?.addEventListener('change',renderProjections);
      qs('#btnPreviewCommission')?.addEventListener('click',doPreview);
      qs('#btnCutOffPeriod')?.addEventListener('click',cutOff);

      // Import/Export
      qs('#btnExportJSON')?.addEventListener('click',()=>{const data=JSON.stringify(state,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pool-data.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url)});
      qs('#fileImport')?.addEventListener('change',e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{try{const data=JSON.parse(ev.target.result); Object.assign(state,data); state.txs=(state.txs||[]).map(t=>({...t,commissionedBy:t.commissionedBy||{}})); saveState(); refreshAll(); alert('Datos importados')}catch(err){alert('JSON inválido'); console.error(err)}}; r.readAsText(f)});

    }catch(err){ console.error('fatal init',err); const warn=document.createElement('div'); warn.className='card'; warn.innerHTML='<b>Error al cargar.</b> Abre la consola para detalle.'; document.body.prepend(warn); }
  });
  </script>
</body>
</html>
